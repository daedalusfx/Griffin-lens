<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Griffin - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ú©Ø§Ù…Ù„ v12.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #2E3440; color: #D8DEE9; }
        .glass-panel { background: rgba(59, 66, 82, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid #4C566A; transition: all 0.3s ease-in-out; }
        .glass-panel:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .metric-card { cursor: pointer; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #4C566A; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .score-ring { stroke-dasharray: 251.2; transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .symbol-select { background-color: #3B4252; border: 1px solid #4C566A; color: #ECEFF4; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.active { background-color: #A3BE8C; }
        .status-dot.frozen { background-color: #BF616A; animation: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(163, 190, 140, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(163, 190, 140, 0); } 100% { box-shadow: 0 0 0 0 rgba(163, 190, 140, 0); } }
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #3B4252; margin: 15% auto; padding: 20px; border: 1px solid #4C566A; width: 80%; max-width: 500px; border-radius: 10px; }
        .close-button { color: #aaa; float: left; font-size: 28px; font-weight: bold; cursor: pointer; }
        /* Sparkline */
        .sparkline { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 80%; height: 20px; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Griffin - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ú©Ø§Ù…Ù„ v12.0</h1>
            <p class="text-gray-400 mt-2">Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ø§Ù…Ø¹ Ú©ÛŒÙÛŒØª Ø¨Ø±ÙˆÚ©Ø±Ù‡Ø§ Ø¨Ø§ ØªÙ…Ø§Ù… Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</p>
        </header>

        <div id="symbol-selector-container" class="max-w-xs mx-auto mb-8"></div>
        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>

    <!-- Modal for Drill-down -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Ø¬Ø²Ø¦ÛŒØ§Øª</h3>
            <div id="modal-body" class="text-gray-300"></div>
        </div>
    </div>

    <script>
        const dashboardGrid = document.getElementById('dashboard-grid');
        const symbolSelectorContainer = document.getElementById('symbol-selector-container');
        const modal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModal = document.querySelector('.close-button');

        const API_URL = 'http://127.0.0.1:5000/api/live_analysis';
        const UPDATE_INTERVAL = 2000;

        let allData = {};
        let selectedSymbol = null;

        // --- Color & Style Helpers ---
        function getColorForScore(score) { return score > 80 ? 'text-green-400' : score > 50 ? 'text-yellow-400' : 'text-red-500'; }
        function getRingColorForScore(score) { return score > 80 ? 'stroke-green-400' : score > 50 ? 'stroke-yellow-400' : 'stroke-red-500'; }
        function getSlippageAsymmetryColor(ratio) { return ratio <= 1.2 ? 'text-green-400' : ratio <= 2.0 ? 'text-yellow-400' : 'text-red-500 font-bold'; }
        
        // --- Sparkline Generator ---
        function createSparkline(history) {
            if (!history || history.length < 2) return '';
            const width = 100, height = 20;
            const max = Math.max(...history);
            const min = Math.min(...history);
            const range = max - min === 0 ? 1 : max - min;
            
            const points = history.map((p, i) => {
                const x = (i / (history.length - 1)) * width;
                const y = height - ((p - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');

            return `<svg class="sparkline" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none"><polyline fill="none" stroke="#88C0D0" stroke-width="1" points="${points}"/></svg>`;
        }

        // --- Modal Logic ---
        closeModal.onclick = () => { modal.style.display = "none"; }
        window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } }

        function showGlitchDetails(brokerName, glitches) {
            modalTitle.innerText = `Ù„Ø§Ú¯ Ú¯Ù„ÛŒÚ†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ${brokerName}`;
            if (!glitches || glitches.length === 0) {
                modalBody.innerHTML = '<p>Ù‡ÛŒÚ† Ú¯Ù„ÛŒÚ† ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ø§Ø®ÛŒØ±Ø§Ù‹ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            } else {
                let content = '<ul class="list-disc list-inside">';
                glitches.forEach(g => {
                    content += `<li class="mb-2">Ø³Ø§Ø¹Øª: <span class="font-mono">${g.time_str}</span> - Ù‚ÛŒÙ…Øª: <span class="font-mono">${g.bid}</span> - Ø´Ø¯Øª: <span class="font-bold text-red-400">${Math.round(g.severity)}</span></li>`;
                });
                content += '</ul>';
                modalBody.innerHTML = content;
            }
            modal.style.display = "block";
        }

        // --- Card Creation ---
        function createBrokerCard(brokerName, data) {
            const isFrozen = data.is_frozen;
            const statusClass = isFrozen ? 'frozen' : 'active';
            const statusText = isFrozen ? `Ù‚Ø·Ø¹` : 'ÙØ¹Ø§Ù„';
            const statusTextColor = isFrozen ? 'text-red-400' : 'text-green-400';

            const qualityScore = data.quality_score || 0;
            const circumference = 2 * Math.PI * 40;
            const scoreOffset = circumference - (qualityScore / 100) * circumference;

            const card = document.createElement('div');
            card.className = 'glass-panel p-5 rounded-xl flex flex-col justify-between';
            card.innerHTML = `
                <div>
                    <!-- Card Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-white truncate pr-2">${brokerName} ${data.is_leader ? 'ğŸ‘‘' : ''}</h3>
                            <div class="flex items-center space-x-2 space-x-reverse mt-1">
                                <div class="status-dot ${statusClass}"></div>
                                <span class="text-sm font-medium ${statusTextColor}">${statusText}</span>
                            </div>
                        </div>
                        <div class="relative w-24 h-24 flex-shrink-0">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-600" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                <circle class="score-ring ${getRingColorForScore(qualityScore)}" stroke-width="8" stroke-dashoffset="${scoreOffset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-2xl font-bold text-white">${Math.round(qualityScore)}</span>
                                ${createSparkline(data.score_history)}
                            </div>
                        </div>
                    </div>

                    <!-- Main KPI Grid -->
                    <div class="grid grid-cols-2 gap-x-4 gap-y-5 text-center my-4">
                        <div class="tooltip metric-card" onclick='showGlitchDetails("${brokerName}", ${JSON.stringify(data.verified_glitches_log || [])})'>
                            <p class="text-sm">Ø§Ù…ØªÛŒØ§Ø² ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ</p>
                            <p class="metric-value text-3xl ${getColorForScore(data.score_integrity || 0)} mt-1">${(data.score_integrity || 0).toFixed(1)}</p>
                             <span class="tooltiptext">Û±Û°Û° Ù…Ù†Ù‡Ø§ÛŒ Ø¬Ø±ÛŒÙ…Ù‡ Ú¯Ù„ÛŒÚ†â€ŒÙ‡Ø§. Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</span>
                        </div>
                        <div class="tooltip">
                            <p class="text-sm">Ø§Ù…ØªÛŒØ§Ø² Ø§ØµØ§Ù„Øª</p>
                            <p class="metric-value text-3xl ${getColorForScore(data.score_authenticity || 0)} mt-1">${(data.score_authenticity || 0).toFixed(1)}</p>
                            <span class="tooltiptext">Ù…ÛŒØ²Ø§Ù† Ø´Ø¨Ø§Ù‡Øª ÙÛŒØ¯ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ.</span>
                        </div>
                        <div class="tooltip">
                            <p class="text-sm">Ú©ÛŒÙÛŒØª Ø§Ø¬Ø±Ø§</p>
                            <p class="metric-value text-3xl ${getColorForScore(data.score_execution || 0)} mt-1">${(data.score_execution || 0).toFixed(1)}</p>
                             <span class="tooltiptext">Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ø¯Ù… ØªÙ‚Ø§Ø±Ù† Ù„ØºØ²Ø´. Ø¹Ø¯Ø¯ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Û±Û°Û° Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø§Ø³Øª.</span>
                        </div>
                        <div class="tooltip">
                            <p class="text-sm">Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ ÙÛŒØ¯</p>
                            <p class="metric-value text-3xl ${getColorForScore(data.score_feed_stability || 0)} mt-1">${Math.round(data.score_feed_stability || 0)}</p>
                             <span class="tooltiptext">Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ØªÛŒÚ©. Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø²Ù†Ø¯Ù‡ Ø¨ÙˆØ¯Ù† ÙÛŒØ¯ Ø§Ø³Øª.</span>
                        </div>
                    </div>
                </div>

                <!-- Footer Metrics -->
                <div class="text-center bg-gray-800/50 p-3 rounded-lg mt-4">
                     <div class="grid grid-cols-3 gap-2">
                         <div>
                            <p class="text-gray-400 text-xs">Ø§Ø³Ù¾Ø±Ø¯</p>
                            <p class="text-white text-base font-semibold">${(data.avg_spread || 0).toFixed(1)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-xs">ØªÛŒÚ© / Ø«Ø§Ù†ÛŒÙ‡</p>
                            <p class="text-white text-base font-semibold">${data.tps || 0}</p>
                        </div>
                         <div>
                            <p class="text-gray-400 text-xs">ØªØ§Ø®ÛŒØ± (ms)</p>
                            <p class="text-white text-base font-semibold">${(data.avg_latency_ms || 0).toFixed(1)}</p>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        // --- Main Update Logic ---
        function updateSymbolSelector(symbols) {
            if (!document.getElementById('symbol-select')) {
                const select = document.createElement('select');
                select.id = 'symbol-select';
                select.className = 'symbol-select w-full p-2 rounded-lg text-center font-bold';
                select.onchange = (e) => {
                    selectedSymbol = e.target.value;
                    renderCardsForSymbol(selectedSymbol);
                };
                symbolSelectorContainer.appendChild(select);
            }
            const select = document.getElementById('symbol-select');
            const existingOptions = new Set(Array.from(select.options).map(o => o.value));
            symbols.forEach(symbol => {
                if (!existingOptions.has(symbol)) {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    select.appendChild(option);
                }
            });
            if (!selectedSymbol && symbols.length > 0) {
                selectedSymbol = symbols[0];
                select.value = selectedSymbol;
            }
        }
        
        function renderCardsForSymbol(symbol) {
            dashboardGrid.innerHTML = '';
            const symbolData = allData[symbol];
            if (!symbolData) {
                dashboardGrid.innerHTML = '<p class="text-center col-span-full text-gray-500">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
                return;
            }
            const sortedBrokers = Object.keys(symbolData).sort((a, b) => (symbolData[b].quality_score || 0) - (symbolData[a].quality_score || 0));
            sortedBrokers.forEach(brokerName => {
                const card = createBrokerCard(brokerName, symbolData[brokerName]);
                dashboardGrid.appendChild(card);
            });
        }

        async function updateDashboard() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Network error: ${response.status}`);
                allData = await response.json();
                
                const symbols = Object.keys(allData).sort();
                if (symbols.length === 0) {
                     dashboardGrid.innerHTML = '<p class="text-center col-span-full text-gray-500">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ„ÛŒÙ† ØªÛŒÚ© Ø§Ø² Ø³Ø±ÙˆØ±...</p>';
                     symbolSelectorContainer.innerHTML = '';
                     return;
                }
                
                updateSymbolSelector(symbols);
                if (selectedSymbol) {
                    renderCardsForSymbol(selectedSymbol);
                }
            } catch (error) {
                console.error("Dashboard update error:", error);
                dashboardGrid.innerHTML = `<p class="text-center col-span-full text-red-400">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± ØªØ­Ù„ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ ØµØ­ÛŒØ­ Ø³Ø±ÙˆØ± Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯.</p>`;
                symbolSelectorContainer.innerHTML = '';
            }
        }

        updateDashboard();
        setInterval(updateDashboard, UPDATE_INTERVAL);
    </script>
</body>
</html>
